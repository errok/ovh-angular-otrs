/*! ovh-angular-otrs - 5.0.0 - 2018-03-02 */
angular.module("ovh-angular-otrs",["ovh-api-services","ovh-angular-toaster","ovh-jquery-ui-draggable-ng"]),angular.module("ovh-angular-otrs").constant("OTRS_POPUP_ASSISTANCE_ENUM",{USAGE:"usage",START:"start",NEW:"new",OTHER:"other"}).constant("OTRS_POPUP_BILLING_ENUM",{INPROGRESS:"inProgress",NEW:"new",BILL:"bill",OTHER:"other"}).constant("OTRS_POPUP_INCIDENT_ENUM",{PERFS:"perfs",ALERTS:"alerts",DOWN:"down"}).constant("OTRS_POPUP_INTERVENTION_ENUM",{REPLACEMENTDISK:"replacement-disk",OTHER:"other"}).constant("OTRS_POPUP_CATEGORIES",{ASSISTANCE:"assistance",BILLING:"billing",INCIDENT:"incident",INTERVENTION:"intervention"}).constant("OTRS_POPUP_SERVICES",{DOMAIN:"DOMAIN",HOSTING:"HOSTING",EMAIL:"EMAIL_DOMAIN",ZONE:"ZONE",SQL:"PRIVATE_DATABASE",EXCHANGE:"EXCHANGE",OFFICE_365:"OFFICE_365",VPS:"VPS",LOAD_BALANCER:"LOAD_BALANCER",FAILOVER:"FAILOVER",CLOUD:"CLOUD",CDN:"CDN_WEBSTORAGE",DEDICATED:"DEDICATED",CDN_DEDICATED:"CDN_DEDICATED"}).constant("OTRS_POPUP_UNIVERSES",{EU:["CLOUD_DEDICATED","SUNRISE","TELECOM","WEB"],CA:["CLOUD_DEDICATED","SUNRISE"],US:["CLOUD_DEDICATED"]}),angular.module("ovh-angular-otrs").controller("OtrsPopupCtrl",["$rootScope","$stateParams","$translate","$q","$transitions","OvhApiMeVipStatus","OvhApiMe","OvhApiSupport","OvhApiProductsAapi","OtrsPopupService","UNIVERSE","TICKET_CATEGORIES","OTRS_POPUP_ASSISTANCE_ENUM","OTRS_POPUP_BILLING_ENUM","OTRS_POPUP_INCIDENT_ENUM","OTRS_POPUP_INTERVENTION_ENUM","OTRS_POPUP_UNIVERSES",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"use strict";function r(){t.ticket={body:null,serviceName:null,subject:null,type:null},t.universes=_.get(q,a.target,q.EU);var b="GAMMA"===k?"SUNRISE":k;t.selectedUniverse=_.includes(["CLOUD","DEDICATED"],b)||!b?"CLOUD_DEDICATED":b}function s(a,b){return a?(t.alert.visible=!0,t.alert.message=a,void(t.alert.type=b)):void(t.alert.visible=!1)}var t=this,u="other";e.onSuccess({},function(a){var b=a.params();b.projectId&&t.services&&-1!==t.services.indexOf(b.projectId)&&(t.ticket.serviceName=b.projectId)}),t.sendTicket=function(){s(),!t.loaders.send&&t.ticket.body&&(t.loaders.send=!0,t.ticket.serviceName===u&&(t.ticket.serviceName="",t.ticket.category=l.DEFAULT),h.Lexi().create(t.ticket).$promise.then(function(b){r(),t.otrsPopupForm.$setUntouched(),t.otrsPopupForm.$setPristine(),a.$broadcast("ticket.otrs.reload"),s(c.instant("otrs_popup_sent_success",{ticketNumber:b.ticketNumber,ticketId:b.ticketId}),"success")},function(a){s([(c.instant("otrs_popup_sent_error"),a.data&&a.data.message||"")].join(" "),"danger")})["finally"](function(){t.loaders.send=!1}))},t.getServices=function(){t.loaders.services=!0,t.services=[],s(),i.get({includeInactives:!0,universe:"CLOUD_DEDICATED"===t.selectedUniverse?"DEDICATED":t.selectedUniverse}).$promise.then(function(a){var b=a.results.map(function(a){return c("otrs_service_category_"+a.name,null,null,a.name).then(function(b){return a.translatedName=b,a})});return d.all(b).then(function(a){a=a.sort(function(a,b){return a.translatedName.localeCompare(b.translatedName)}),a.push({translatedName:c.instant("otrs_service_category_other"),services:[{serviceName:u,displayName:c.instant("otrs_service_category_other")}]}),t.services=a})})["catch"](function(a){s([(c.instant("otrs_err_get_infos"),a.data&&a.data.message||"")].join(" "),"danger")})["finally"](function(){t.loaders.services=!1})},this.$onInit=function(){r(),t.loaders={send:!1,models:!0},t.alert={visible:!1,type:null,message:null},t.isVIP=!1,t.getServices(),s(),d.all([g.Lexi().get().$promise,h.Lexi().schema().$promise]).then(function(a){t.types=a[1].models["support.TicketTypeEnum"]["enum"],t.categories=a[1].models["support.TicketProductEnum"]["enum"],t.requests=a[1].models["support.TicketCategoryEnum"]["enum"],t.subCategories={assistance:[m.USAGE,m.START],billing:[n.INPROGRESS,n.BILL],incident:[o.PERFS,o.ALERTS,o.DOWN],intervention:[p.REPLACEMENTDISK,p.OTHER]},"FR"!==a[0].ovhSubsidiary&&(t.subCategories.assistance.splice(2,0,m.NEW),t.subCategories.assistance.splice(3,0,m.OTHER),t.subCategories.billing.splice(1,0,m.NEW),t.subCategories.billing.splice(3,0,m.OTHER),t.subCategories.incident.splice(3,0,m.OTHER)),1===t.categories.length&&(t.ticket.product=t.categories[0])})["catch"](function(a){s([(c.instant("otrs_err_get_infos"),a.data&&a.data.message||"")].join(" "),"danger")})["finally"](function(){t.loaders.models=!1}),f.Lexi().get().$promise.then(function(a){t.isVIP=-1!==_.values(a.toJSON()).indexOf(!0)})}}]),angular.module("ovh-angular-otrs").directive("otrsPopup",function(){"use strict";return{restrict:"A",scope:{},replace:!1,templateUrl:"app/module-otrs/otrs-popup/otrs-popup.html",link:function(a){a.status={minimize:!1,maximize:!1,close:!1},a.minimize=function(){a.status.maximize=!1,a.status.minimize=!0,a.status.close=!1},a.maximize=function(){a.status.maximize=!0,a.status.minimize=!1,a.status.close=!1},a.restore=function(){a.status.maximize=!1,a.status.minimize=!1,a.status.close=!1},a.toggle=function(){a.status.maximize||a.status.minimize?a.restore():a.maximize()},a.close=function(){a.restore(),a.status.close=!0},a.$on("otrs.popup.maximize",a.maximize),a.$on("otrs.popup.minimize",a.minimize),a.$on("otrs.popup.restore",a.restore),a.$on("otrs.popup.toggle",a.toggle),a.$on("otrs.popup.close",a.close)}}}),angular.module("ovh-angular-otrs").service("OtrsPopupService",["$rootScope","$compile",function(a,b){"use strict";var c=this,d=["minimize","maximize","restore","close"],e=!1;angular.forEach(d,function(b){c[b]=function(c){a.$broadcast("otrs.popup."+b,c)}}),this.toggle=function(){$("[otrs-popup] .draggable").hasClass("close")?c.restore():c.close()},this.init=function(){b("<div otrs-popup></div>")(a,function(a){$("body").append(a),e=!0})},this.isLoaded=function(){return e}}]),angular.module("ovh-angular-otrs").constant("TICKET_CATEGORIES",{LIST:{WEB:["cdn","domain","exchange","hosting","mail","ssl","vps","web-billing","web-other"],TELECOM:["adsl","voip","fax","sms","telecom-billing","telecom-other"],DEDICATED:["dedicated","dedicatedcloud","housing","dedicated-other","dedicated-billing"],CLOUD:["publiccloud"]},DEFAULT:"billing"}),angular.module("ovh-angular-otrs").run(["$templateCache",function(a){"use strict";a.put("app/module-otrs/otrs-popup/otrs-popup.html","<div class=\"draggable otrs-popup\" data-draggable data-options=\"{\n         containment: 'body',\n         handle: '#headerPopup,\n         #contentPopup form'\n     }\" data-ng-class=\"{\n        'minimize': status.minimize,\n        'maximize': status.maximize,\n        'close': status.close\n"+'    }"><div class=draggable-header id=headerPopup><span data-translate=otrs_popup_title></span><div class="otrs_popup_tools float-right"><button type=button aria-label="{{:: \'otrs_popup_icon_minimize\' | translate }}" data-ng-click=minimize()><span class="fa fa-window-minimize" aria-hidden=true></span></button> <button type=button aria-label="{{:: \'otrs_popup_icon_maximize\' | translate }}" data-ng-click=toggle()><span class="fa fa-window-maximize" aria-hidden=true></span></button> <button type=button aria-label="{{:: \'otrs_popup_icon_close\' | translate }}" data-ng-click=close()><span class="fa fa-close" aria-hidden=true></span></button></div></div><div id=contentPopup data-ng-controller="OtrsPopupCtrl as OtrsPopupCtrl"><p class="text-center font-italic" data-translate=otrs_popup_move></p><p class="text-center font-italic" data-ng-if=OtrsPopupCtrl.isVIP data-translate=otrs_vip_phone></p><div class="alert alert-dismissible" role=alert data-ng-class="\'alert-\' + OtrsPopupCtrl.alert.type" data-ng-if=OtrsPopupCtrl.alert.visible><button type=button class=close data-dismiss=alert aria-label=Close><span aria-hidden=true>&times;</span></button><p data-ng-bind-html=OtrsPopupCtrl.alert.message></p></div><form id=otrsPopupForm name=OtrsPopupCtrl.otrsPopupForm novalidate data-ng-submit=OtrsPopupCtrl.sendTicket()><div class=form-group data-ng-if="OtrsPopupCtrl.universes.length > 1"><label for=select-universe class=control-label data-translate=otrs_universe_choice></label><select class=form-control id=select-universe name=select-universe required data-ng-model=OtrsPopupCtrl.selectedUniverse data-ng-options="universe as ( \'otrs_universe_\'+ universe | translate ) for universe in OtrsPopupCtrl.universes" data-ng-change=OtrsPopupCtrl.getServices()></select></div><div class=form-group><label for=select-services class=control-label><span data-translate=otrs_popup_service></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.services data-size=s></oui-spinner></label><select class=form-control id=select-services name=select-services required data-ng-model=OtrsPopupCtrl.ticket.serviceName data-ng-disabled=OtrsPopupCtrl.loaders.services><optgroup label="{{ category.translatedName }}" data-ng-repeat="category in OtrsPopupCtrl.services track by $index"><option value="{{ service.serviceName }}" data-ng-repeat="service in category.services track by $index" data-ng-bind=service.displayName></option></optgroup></select></div><div class=form-group data-ng-if=OtrsPopupCtrl.isVIP><label for=select-types class=control-label><span data-translate=otrs_popup_type></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.models data-size=s></oui-spinner></label><select class=form-control id=select-types name=select-types data-ng-model=OtrsPopupCtrl.ticket.type data-ng-options="type as ( \'otrs_types_\'+type | translate ) for type in OtrsPopupCtrl.types" data-ng-disabled=OtrsPopupCtrl.loaders.models></select></div><div class=form-group><label for=select-requests class=control-label><span data-translate=otrs_category_choice></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.models data-size=s></oui-spinner></label><select class=form-control id=select-requests name=select-requests required data-ng-model=OtrsPopupCtrl.ticket.category data-ng-options="request as ( \'otrs_category_\'+request | translate ) for request in OtrsPopupCtrl.requests" data-ng-disabled=OtrsPopupCtrl.loaders.models></select></div><div class=form-group data-ng-show=OtrsPopupCtrl.ticket.category><label for=select-subCategories class=control-label><span data-translate=otrs_subCategory_choice></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.models data-size=s></oui-spinner></label><select class=form-control id=select-subCategories name=select-requests required data-ng-model=OtrsPopupCtrl.ticket.subcategory data-ng-options="subCategory as (\'otrs_subCategory_\' + OtrsPopupCtrl.ticket.category + \'_\' + subCategory | translate) for subCategory in OtrsPopupCtrl.subCategories[OtrsPopupCtrl.ticket.category]" data-ng-disabled=OtrsPopupCtrl.loaders.models></select></div><div class=form-group><label for=txt-subject class=control-label data-translate=otrs_popup_subject></label><input id=txt-subject name=txt-subject class=form-control required placeholder="{{:: \'otrs_popup_subject\' | translate }}" data-ng-model=OtrsPopupCtrl.ticket.subject></div><div class=form-group><label for=txt-message class=control-label data-translate=otrs_popup_body></label><textarea id=txt-message name=txt-message class=form-control rows=8 required placeholder="{{:: \'otrs_popup_body\' | translate }}" data-ng-model=OtrsPopupCtrl.ticket.body>\n                </textarea></div><div class=form-group><button type=submit class="btn btn-block btn-primary" data-ng-disabled="!OtrsPopupCtrl.otrsPopupForm.$valid || OtrsPopupCtrl.loaders.services || OtrsPopupCtrl.loaders.send"><span class="fa fa-envelope" aria-hidden=true></span> <span data-translate=otrs_popup_add_ticket></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.send data-size=s></oui-spinner></button></div></form></div></div>')}]);
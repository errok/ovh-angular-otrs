/*! ovh-angular-otrs - 5.0.0 - 2018-04-05 */
angular.module("ovh-angular-otrs",["ovh-api-services","ovh-angular-toaster","ovh-jquery-ui-draggable-ng"]),angular.module("ovh-angular-otrs").service("OtrsPopupInterventionService",["$q","OvhApiDedicatedServer",function(a,b){"use strict";function c(a){return b.v6().get({serverName:a}).$promise}function d(a){return b.v6().getHardware({serverName:a}).$promise}function e(a,b){return"HG"===a.commercialRange.toUpperCase()&&_.includes(["2U","4U"],b.formFactor.toUpperCase())}function f(a){return _.some(a.diskGroups,{raidController:"MegaRaid"})}function g(a,b){var c="HG"===a.commercialRange.toUpperCase(),d=b.formFactor&&"4U"===b.formFactor.toUpperCase()?24:12;return{canUseSlotId:c,slotsCount:d}}var h=this;h.sendDiskReplacement=function(a,c){var d=_.assign({},c);return d.comment||(d.comment="No message"),b.v6().askHardDiskDriveReplacement({serverName:a},{comment:d.comment,disks:d.disks,inverse:d.inverse}).$promise},h.getServerInterventionInfo=function(b){return a.all({serverInfo:c(b),hardwareInfo:d(b)}).then(function(a){return{canHotSwap:e(a.serverInfo,a.hardwareInfo),hasMegaRaid:f(a.hardwareInfo),slotInfo:g(a.serverInfo,a.hardwareInfo)}})}}]),angular.module("ovh-angular-otrs").constant("OTRS_POPUP_ASSISTANCE_ENUM",{USAGE:"usage",START:"start",NEW:"new",OTHER:"other"}).constant("OTRS_POPUP_BILLING_ENUM",{INPROGRESS:"inProgress",NEW:"new",BILL:"bill",OTHER:"other"}).constant("OTRS_POPUP_INCIDENT_ENUM",{PERFS:"perfs",ALERTS:"alerts",DOWN:"down"}).constant("OTRS_POPUP_INTERVENTION_ENUM",{REPLACEMENTDISK:"replacement-disk",OTHER:"other"}).constant("OTRS_POPUP_CATEGORIES",{ASSISTANCE:"assistance",BILLING:"billing",INCIDENT:"incident",INTERVENTION:"intervention"}).constant("OTRS_POPUP_SERVICES",{DOMAIN:"DOMAIN",HOSTING:"HOSTING",EMAIL:"EMAIL_DOMAIN",ZONE:"ZONE",SQL:"PRIVATE_DATABASE",EXCHANGE:"EXCHANGE",OFFICE_365:"OFFICE_365",VPS:"VPS",LOAD_BALANCER:"LOAD_BALANCER",FAILOVER:"FAILOVER",CLOUD:"CLOUD",CDN:"CDN_WEBSTORAGE",DEDICATED:"DEDICATED",CDN_DEDICATED:"CDN_DEDICATED"}).constant("OTRS_POPUP_UNIVERSES",{EU:["CLOUD_DEDICATED","SUNRISE","TELECOM","WEB"],CA:["CLOUD_DEDICATED","SUNRISE"],US:["CLOUD_DEDICATED"]}),angular.module("ovh-angular-otrs").controller("OtrsPopupCtrl",["$q","$rootScope","$scope","$stateParams","$transitions","$translate","OvhApiMe","OvhApiMeVipStatus","OvhApiProductsAapi","OvhApiSupport","OtrsPopupService","OtrsPopupInterventionService","OTRS_POPUP_ASSISTANCE_ENUM","OTRS_POPUP_BILLING_ENUM","OTRS_POPUP_CATEGORIES","OTRS_POPUP_INCIDENT_ENUM","OTRS_POPUP_INTERVENTION_ENUM","OTRS_POPUP_SERVICES","OTRS_POPUP_UNIVERSES","TICKET_CATEGORIES","UNIVERSE",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){"use strict";function v(){A.ticket={body:null,serviceName:null,subject:null,type:null},A.universes=_.get(s,b.target,s.EU);var a="GAMMA"===u?"SUNRISE":u;A.selectedUniverse=_.includes(["CLOUD","DEDICATED"],a)||!a?"CLOUD_DEDICATED":a,A.intervention={serviceName:null,request:"intervention",disk:{comment:null,disks:[{id:1}],inverse:!1},hasMegaRaid:!1,slotInfo:{},enums:{slotID:[]}}}function w(a,b){return a?(A.alert.visible=!0,A.alert.message=a,void(A.alert.type=b)):void(A.alert.visible=!1)}function x(){return _.filter(A.services,function(a){return _.find(a.services,{serviceName:A.ticket.serviceName})})}function y(){return"SERVER"===_.first(_.map(x(),"name"))}function z(){return A.loaders.intervention=!0,A.intervention.canHotSwap=!1,A.intervention.hasMegaRaid=!1,A.intervention.slotInfo.canUseSlotId=null,A.intervention.slotInfo.slotsCount=0,l.getServerInterventionInfo(A.intervention.serviceName).then(function(a){A.intervention.canHotSwap=a.canHotSwap,A.intervention.hasMegaRaid=a.hasMegaRaid,A.intervention.slotInfo=a.slotInfo,A.intervention.slotInfo.canUseSlotId&&(A.intervention.enums.slotID=Array.apply(null,{length:A.intervention.slotInfo.slotsCount}).map(Number.call,Number))})["catch"](function(){w(f.instant("otrs_intervention_disk_error"),"danger")})["finally"](function(){A.loaders.intervention=!1})}var A=this,B="other";A.loaders={send:!1,services:!1,models:!1,intervention:!1},A.currentUser=null,A.isVIP=!1,A.services=[],e.onSuccess({},function(a){var b=a.params();b.projectId&&A.services&&-1!==A.services.indexOf(b.projectId)&&(A.ticket.serviceName=b.projectId)}),A.getServices=function(){return A.loaders.services=!0,w(),i.get({includeInactives:!0,universe:"CLOUD_DEDICATED"===A.selectedUniverse?"DEDICATED":A.selectedUniverse}).$promise.then(function(b){var c=b.results.map(function(a){return f("otrs_service_category_"+a.name,null,null,a.name).then(function(b){return a.translatedName=b,a})});return a.all(c).then(function(a){return a=a.sort(function(a,b){return a.translatedName.localeCompare(b.translatedName)}),a.push({translatedName:f.instant("otrs_service_category_other"),services:[{serviceName:B,displayName:f.instant("otrs_service_category_other")}]}),A.services=a,a})})["catch"](function(a){w([(f.instant("otrs_err_get_infos"),a.data&&a.data.message||"")].join(" "),"danger")})["finally"](function(){A.loaders.services=!1})},A.sendTicket=function(){return w(),!A.loaders.send&&A.ticket.body?(A.loaders.send=!0,A.ticket.serviceName===B&&(A.ticket.serviceName="",A.ticket.category=t.DEFAULT),j.v6().create(A.ticket).$promise.then(function(a){v(),A.otrsPopupForm.$setUntouched(),A.otrsPopupForm.$setPristine(),b.$broadcast("ticket.otrs.reload"),w(f.instant("otrs_popup_sent_success",{ticketNumber:a.ticketNumber,ticketId:a.ticketId}),"success")})["catch"](function(a){w([(f.instant("otrs_popup_sent_error"),a.data&&a.data.message||"")].join(" "),"danger")})["finally"](function(){A.loaders.send=!1})):a.when()},A.sendDiskReplacement=function(){return A.loaders.send?a.when():(A.loaders.send=!0,l.sendDiskReplacement(A.intervention.serviceName,A.intervention.disk).then(function(a){v(),b.$broadcast("ticket.otrs.reload"),w(f.instant("otrs_popup_sent_success",{ticketNumber:a.ticketNumber,ticketId:a.ticketId}),"success")})["catch"](function(a){if(_.includes(a.message,"This feature is currently not supported in your datacenter"))w(f.instant("otrs_popup_sent_error_not_available"),"danger");else if(_.includes(a.message,"Action pending : ticketId ")){var b=/\d+$/.exec(a.message);w(f.instant("otrs_popup_sent_error_already_exists",{ticketId:b}),"danger")}else w([f.instant("otrs_popup_sent_error"),_.get(a,"message","")].join(" "),"danger")})["finally"](function(){A.loaders.send=!1,A.refreshRequests(),A.setForm("start")}))},A.refreshRequests=function(){y()&&!_.includes(A.requests,A.intervention.request)?A.requests.push(A.intervention.request):y()||(_.remove(A.requests,function(a){return A.intervention.request===a}),A.ticket.category=void 0,A.ticket.subcategory=null)},A.refreshFormDetails=function(){A.ticket.subcategory===q.REPLACEMENTDISK&&"message"===A.formDetails&&(A.refreshRequests(),A.setForm("start"))},A.addDisk=function(){var a=A.intervention.disk.disks.length+1;A.intervention.disk.disks.push({id:a})},A.removeChoice=function(a){A.intervention.disk.disks.splice(a,1)},A.setForm=function(a){A.formDetails=a},A.continueForm=function(){A.ticket&&A.ticket.category===o.INTERVENTION&&A.ticket.subcategory===q.REPLACEMENTDISK?(A.intervention.serviceName=A.ticket.serviceName,A.setForm(q.REPLACEMENTDISK)):A.ticket&&A.ticket.category===o.INTERVENTION&&A.ticket.subcategory===q.OTHER?(A.ticket.category=o.INCIDENT,A.ticket.subcategory=p.DOWN,A.setForm("message")):A.setForm("message")},this.$onInit=function(){return v(),A.alert={visible:!1,type:null,message:null},A.servicesValues=r,A.formDetails="start",A.interventionEnum=q,w(),a.all({services:A.getServices(),me:g.v6().get().$promise,meVipStatus:h.v6().get().$promise,supportSchema:j.v6().schema().$promise}).then(function(a){A.currentUser=a.me,A.isVIP=-1!==_.values(a.meVipStatus.toJSON()).indexOf(!0),A.types=a.supportSchema.models["support.TicketTypeEnum"]["enum"],A.categories=a.supportSchema.models["support.TicketProductEnum"]["enum"],A.requests=a.supportSchema.models["support.TicketCategoryEnum"]["enum"],A.subCategories={assistance:[m.USAGE,m.START],billing:[n.INPROGRESS,n.BILL],incident:[p.PERFS,p.ALERTS,p.DOWN],intervention:[q.REPLACEMENTDISK]},"FR"!==A.currentUser.ovhSubsidiary&&(A.subCategories.assistance.splice(2,0,m.NEW),A.subCategories.assistance.splice(3,0,m.OTHER),A.subCategories.billing.splice(1,0,m.NEW),A.subCategories.billing.splice(3,0,m.OTHER),A.subCategories.incident.splice(3,0,m.OTHER)),1===A.categories.length&&(A.ticket.product=A.categories[0]),c.$watch("OtrsPopupCtrl.intervention.serviceName",function(a,b){a&&a!==b&&z()}),c.$watch("OtrsPopupCtrl.ticket.serviceName",function(){A.refreshFormDetails(),A.refreshRequests()}),c.$watch("OtrsPopupCtrl.ticket.subcategory",function(){A.refreshFormDetails()})})["catch"](function(a){w([(f.instant("otrs_err_get_infos"),a.data&&a.data.message||"")].join(" "),"danger")})["finally"](function(){A.loaders.models=!1})}}]),angular.module("ovh-angular-otrs").directive("otrsPopup",function(){"use strict";return{restrict:"A",scope:{},replace:!1,templateUrl:"app/module-otrs/otrs-popup/otrs-popup.html",link:function(a){a.status={minimize:!1,maximize:!1,close:!0},a.minimize=function(){a.status.maximize=!1,a.status.minimize=!0,a.status.close=!1},a.maximize=function(){a.status.maximize=!0,a.status.minimize=!1,a.status.close=!1},a.restore=function(){a.status.maximize=!1,a.status.minimize=!1,a.status.close=!1},a.toggle=function(){a.status.maximize||a.status.minimize?a.restore():a.maximize()},a.open=function(){a.restore(),a.status.close=!1},a.close=function(){a.restore(),a.status.close=!0},a.$on("otrs.popup.maximize",a.maximize),a.$on("otrs.popup.minimize",a.minimize),a.$on("otrs.popup.restore",a.restore),a.$on("otrs.popup.toggle",a.toggle),a.$on("otrs.popup.open",a.open),a.$on("otrs.popup.close",a.close)}}}),angular.module("ovh-angular-otrs").service("OtrsPopupService",["$rootScope",function(a){"use strict";var b=this,c=["minimize","maximize","restore","close","open"],d=!1;angular.forEach(c,function(c){b[c]=function(b){a.$broadcast("otrs.popup."+c,b)}}),this.toggle=function(){$("[data-otrs-popup] .draggable").hasClass("close")?b.open():b.close()},this.init=function(){b.open(),d=!0},this.isLoaded=function(){return d}}]),angular.module("ovh-angular-otrs").constant("TICKET_CATEGORIES",{LIST:{WEB:["cdn","domain","exchange","hosting","mail","ssl","vps","web-billing","web-other"],TELECOM:["adsl","voip","fax","sms","telecom-billing","telecom-other"],DEDICATED:["dedicated","dedicatedcloud","housing","dedicated-other","dedicated-billing"],CLOUD:["publiccloud"]},DEFAULT:"billing"}),angular.module("ovh-angular-otrs").run(["$templateCache",function(a){"use strict";a.put("app/module-otrs/otrs-popup/otrs-popup.html","<div class=\"draggable otrs-popup\" data-draggable data-options=\"{\n         containment: 'body',\n         handle: '#headerPopup,\n         #contentPopup form'\n     }\" data-ng-class=\"{\n        'minimize': status.minimize,\n        'maximize': status.maximize,\n        'close': status.close\n"+'    }"><div data-ng-controller="OtrsPopupCtrl as OtrsPopupCtrl"><div class=draggable-header id=headerPopup><span data-ng-if="OtrsPopupCtrl.formDetails === \'replacement-disk\'" data-translate=otrs_popup_intervention></span> <span data-ng-if="OtrsPopupCtrl.formDetails !== \'replacement-disk\'" data-translate=otrs_popup_title></span><div class="otrs_popup_tools float-right"><button type=button aria-label="{{:: \'otrs_popup_icon_minimize\' | translate }}" data-ng-click="status.minimize ? restore() : minimize()"><span class="fa fa-window-minimize" aria-hidden=true></span></button> <button type=button aria-label="{{:: \'otrs_popup_icon_maximize\' | translate }}" data-ng-click="status.maximize ? restore() : maximize()"><span class="fa fa-window-maximize" aria-hidden=true></span></button> <button type=button aria-label="{{:: \'otrs_popup_icon_close\' | translate }}" data-ng-click=close()><span class="fa fa-close" aria-hidden=true></span></button></div></div><div id=contentPopup><p class="text-center font-italic" data-translate=otrs_popup_move></p><p class="text-center font-italic" data-ng-if=OtrsPopupCtrl.isVIP data-translate=otrs_vip_phone></p><div class="alert alert-dismissible" role=alert data-ng-class="\'alert-\' + OtrsPopupCtrl.alert.type" data-ng-if=OtrsPopupCtrl.alert.visible><button type=button class=close data-dismiss=alert aria-label=Close><span aria-hidden=true>&times;</span></button><p data-ng-bind-html=OtrsPopupCtrl.alert.message></p></div><form id=otrsPopupForm name=OtrsPopupCtrl.otrsPopupForm novalidate data-ng-hide="OtrsPopupCtrl.formDetails === \'replacement-disk\'" data-ng-submit=OtrsPopupCtrl.sendTicket()><div class=form-group data-ng-if="OtrsPopupCtrl.universes.length > 1"><label for=select-universe class=control-label data-translate=otrs_universe_choice></label><select class=form-control id=select-universe name=select-universe required data-ng-model=OtrsPopupCtrl.selectedUniverse data-ng-options="universe as ( \'otrs_universe_\'+ universe | translate ) for universe in OtrsPopupCtrl.universes" data-ng-change=OtrsPopupCtrl.getServices()></select></div><div class=form-group><label for=select-services class=control-label><span data-translate=otrs_popup_service></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.services data-size=s></oui-spinner></label><select class=form-control id=select-services name=select-services required data-ng-model=OtrsPopupCtrl.ticket.serviceName data-ng-disabled=OtrsPopupCtrl.loaders.services><optgroup label="{{ category.translatedName }}" data-ng-repeat="category in OtrsPopupCtrl.services track by $index"><option value="{{ service.serviceName }}" data-ng-repeat="service in category.services track by $index" data-ng-bind=service.displayName></option></optgroup></select><small data-ng-show=OtrsPopupCtrl.productHasFaq() data-translate=otrs_popup_see_faq data-translate-values="{\n                               url: OtrsPopupCtrl.faq.url\n                           }"></small></div><div class=form-group data-ng-if=OtrsPopupCtrl.isVIP><label for=select-types class=control-label><span data-translate=otrs_popup_type></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.models data-size=s></oui-spinner></label><select class=form-control id=select-types name=select-types data-ng-model=OtrsPopupCtrl.ticket.type data-ng-options="type as ( \'otrs_types_\'+type | translate ) for type in OtrsPopupCtrl.types" data-ng-disabled=OtrsPopupCtrl.loaders.models></select></div><div class=form-group><label for=select-requests class=control-label><span data-translate=otrs_category_choice></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.models data-size=s></oui-spinner></label><select class=form-control id=select-requests name=select-requests required data-ng-model=OtrsPopupCtrl.ticket.category data-ng-options="request as ( \'otrs_category_\'+request | translate ) for request in OtrsPopupCtrl.requests" data-ng-disabled=OtrsPopupCtrl.loaders.models></select></div><div class=form-group data-ng-show=OtrsPopupCtrl.ticket.category><label for=select-subCategories class=control-label><span data-translate=otrs_subCategory_choice></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.models data-size=s></oui-spinner></label><select class=form-control id=select-subCategories name=select-requests required data-ng-model=OtrsPopupCtrl.ticket.subcategory data-ng-options="subCategory as (\'otrs_subCategory_\' + OtrsPopupCtrl.ticket.category + \'_\' + subCategory | translate) for subCategory in OtrsPopupCtrl.subCategories[OtrsPopupCtrl.ticket.category]" data-ng-disabled=OtrsPopupCtrl.loaders.models></select></div><div data-ng-switch=OtrsPopupCtrl.formDetails><div data-ng-switch-when=start><button type=button class="btn btn-block btn-default" data-ng-disabled="OtrsPopupCtrl.loaders.services || OtrsPopupCtrl.loaders.send" data-ng-click=OtrsPopupCtrl.continueForm() data-translate=otrs_popup_continue></button></div><div data-ng-switch-when=message><div class=form-group><label for=txt-subject class=control-label data-translate=otrs_popup_subject></label><input id=txt-subject name=txt-subject class=form-control required placeholder="{{:: \'otrs_popup_subject\' | translate }}" data-ng-model=OtrsPopupCtrl.ticket.subject></div><div class=form-group><label for=txt-message class=control-label data-translate=otrs_popup_body></label><textarea id=txt-message name=txt-message class=form-control rows=4 required placeholder="{{:: \'otrs_popup_body\' | translate }}" data-ng-model=OtrsPopupCtrl.ticket.body>\n                            </textarea></div><div class=form-group><button type=submit class="btn btn-block btn-primary" data-ng-disabled="!OtrsPopupCtrl.otrsPopupForm.$valid || OtrsPopupCtrl.loaders.services || OtrsPopupCtrl.loaders.send"><span data-translate=otrs_popup_add_ticket></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.send data-size=s></oui-spinner></button></div></div><div data-ng-switch-when=replacement-disk></div></div></form><form id=diskReplacement name=diskReplacement data-ng-if="OtrsPopupCtrl.formDetails === OtrsPopupCtrl.interventionEnum.REPLACEMENTDISK" data-ng-submit=OtrsPopupCtrl.sendDiskReplacement()><div class=form-group><label class=control-label for=diskReplacementService><span data-translate=otrs_popup_service></span><oui-spinner data-ng-show=OtrsPopupCtrl.loaders.services data-size=s></oui-spinner><button class="btn btn-link" data-ng-hide=OtrsPopupCtrl.loaders.services data-ng-click=OtrsPopupCtrl.getServices(true) data-ng-disabled=OtrsPopupCtrl.loaders.send><span class="fa fa-refresh" aria-hidden=true></span> <span data-translate=otrs_popup_services_refresh></span></button></label><select class=form-control id=diskReplacementService name=diskReplacementService required data-ng-model=OtrsPopupCtrl.intervention.serviceName data-ng-disabled=OtrsPopupCtrl.loaders.services><optgroup label="{{ category.translatedName }}" data-ng-repeat="category in OtrsPopupCtrl.services track by $index"><option value="{{ service.serviceName }}" data-ng-repeat="service in category.services track by $index" data-ng-bind=service.displayName></option></optgroup></select></div><div class=text-center data-ng-show=OtrsPopupCtrl.loaders.intervention><oui-spinner></oui-spinner></div><div class=form-group><label class=control-label for=diskSerial><span data-ng-if=OtrsPopupCtrl.intervention.disk.inverse data-translate=otrs_intervention_disk_id_label_not></span> <span data-ng-if=!OtrsPopupCtrl.intervention.disk.inverse data-translate=otrs_intervention_disk_id_label></span></label><div class=input-group data-ng-repeat="disk in OtrsPopupCtrl.intervention.disk.disks"><input class=form-control name=diskSerial required data-ng-model=disk.disk_serial data-translate-attr="{\n                                   \'placeholder\': \'otrs_intervention_disk_serial_placeholder\'\n                               }"><select data-ng-if=OtrsPopupCtrl.intervention.slotInfo.canUseSlotId data-ng-model=disk.slot_id data-ng-options="n for n in OtrsPopupCtrl.intervention.enums.slotID"><option value="" selected disabled data-translate=otrs_intervention_disk_slotID></option></select><span class=input-group-btn><button type=button class="btn btn-default" data-ng-show=$first data-ng-click=OtrsPopupCtrl.addDisk()><span class="fa fa-plus" aria-hidden=true></span></button> <button type=button class="btn btn-default" data-ng-show=!$first data-ng-click=OtrsPopupCtrl.removeChoice($index)><span class="fa fa-minus" aria-hidden=true></span></button></span></div><div class=checkbox><label><input type=checkbox name=diskReplacementReverse id=diskReplacementReverse data-ng-model=OtrsPopupCtrl.intervention.disk.inverse> <span data-translate=otrs_intervention_disk_id_not_retrievable></span></label></div><div class=form-group><label for=diskReplacementComment class=control-label data-translate=otrs_intervention_disk_comment></label><textarea rows=4 name=diskReplacementComment id=diskReplacementComment class=form-control data-ng-model=OtrsPopupCtrl.intervention.disk.comment>\n                    </textarea><span id=helpDiskReplacementComment class="help-block italic" data-translate=otrs_intervention_disk_comment_english_please></span></div><div class="form-group confirmation"><p data-ng-if=OtrsPopupCtrl.intervention.canHotSwap data-ng-bind-html="tr(\'otrs_intervention_disk_warning_hotswap\')"></p><p data-ng-if=!OtrsPopupCtrl.intervention.canHotSwap data-ng-bind-html="tr(\'otrs_intervention_disk_warning2\')"></p><div class=checkbox><label><input type=checkbox name=diskReplacementConfirm id=diskReplacementConfirm data-ng-model=OtrsPopupCtrl.intervention.confirm> <span data-translate=otrs_intervention_disk_confirm></span></label></div></div><button type=button class="btn btn-block btn-default" data-ng-click="OtrsPopupCtrl.setForm(\'start\')" data-translate=otrs_popup_back></button> <button type=submit class="btn btn-block btn-primary" data-ng-disabled="!diskReplacement.$valid ||\n                                           OtrsPopupCtrl.loaders.services ||\n                                           OtrsPopupCtrl.loaders.send ||\n                                           !OtrsPopupCtrl.intervention.confirm ||\n                                           OtrsPopupCtrl.loaders.intervention"><span data-translate=otrs_popup_add_ticket></span><oui-spinner data-ng-if=OtrsPopupCtrl.loaders.send data-size=s></oui-spinner></button></div></form></div></div></div>')}]);